WITH
  LastPaidClick AS (
    -- Находим последний платный визит ДО создания лида для каждого лида
    SELECT
        s.visitor_id,
        s.visit_date,
        s.source AS utm_source,
        s.medium AS utm_medium,
        s.campaign AS utm_campaign,
        l.lead_id,
        l.created_at AS lead_created_at,
        l.amount,
        l.closing_reason,
        l.status_id,
        ROW_NUMBER() OVER (PARTITION BY s.visitor_id ORDER BY s.visit_date DESC) AS rn
    FROM sessions s
    left JOIN leads l
        ON s.visitor_id = l.visitor_id
        AND s.visit_date <= l.created_at
    WHERE s.medium IN ('cpc', 'cpm', 'cpa', 'youtube', 'cpp', 'tg', 'social')
  )
  ,AttributedLeads AS (
    -- Оставляем только последний платный визит для каждого лида
    SELECT
        cast(visit_date as date) as visit_date,
        utm_source,
        utm_medium,
        utm_campaign,
        count(visitor_id) as visitors_count,
        count(lead_id) as leads_count,
        count(case when status_id = '142' then lead_id else null end) as purchases_count,
        coalesce(sum(amount), 0) as revenue
    FROM LastPaidClick
    WHERE rn = 1
    group by 1,2,3,4
  ),
  DailyCosts AS (
    -- Объединяем расходы из двух таблиц (замените vk_ads, ya_ads на реальные имена!)
    SELECT
        cast(campaign_date as date) AS visit_date,
        utm_source,
        utm_medium,
        utm_campaign,
        sum(daily_spent) AS total_cost
    FROM vk_ads
	group by 1,2,3,4
    UNION ALL
    SELECT
        cast(campaign_date as date) AS visit_date,
        utm_source,
        utm_medium,
        utm_campaign,
        sum(daily_spent) AS total_cost
    FROM ya_ads
    	group by 1,2,3,4
  ), alpc as (
    SELECT
        dv.visit_date,
        dv.visitors_count,
        dv.utm_source,
        dv.utm_medium,
        dv.utm_campaign,
        dv.leads_count,
        dv. purchases_count,
        dv.revenue,
        coalesce(ac.total_cost, 0) as total_cost
    FROM AttributedLeads dv
    LEFT JOIN DailyCosts ac
        ON dv.visit_date = ac.visit_date
        AND dv.utm_source = ac.utm_source
        AND dv.utm_medium = ac.utm_medium
        AND dv.utm_campaign = ac.utm_campaign
--ORDER BY revenue DESC NULLS LAST        -- от большего к меньшему, null в конце
--LIMIT 15;
        )
        select 
        utm_source,
        sum(total_cost)*100.0/sum(visitors_count) as cpu,
        sum(total_cost)*100.0/sum(leads_count) as cpl,
        sum(total_cost)*100.0/sum(purchases_count) as cpl,
        (sum(revenue)-sum(total_cost))*100.0/sum(total_cost) as roi
        from alpc 
        where utm_source in ('vk', 'yandex')
        group by 1